<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Người dùng</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 20px; color: #333; }

        /* Search Bar */
        .search-bar { margin-bottom: 15px; }
        .search-bar input { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px; }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            table-layout: fixed; /* Thêm dòng này để cố định khung bảng */
        }
        td {word-wrap: break-word;}
        th, td { padding: 12px; text-align: left; border: 1px solid #ddd; }
        th { background: #4CAF50; color: white; font-weight: bold; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background: #f5f5f5; }

        /* Buttons */
        button { padding: 8px 16px; margin: 0 4px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; }
        .modal-content input { width: 100%; padding: 8px; margin: 5px 0 15px; display: block; border: 1px solid #ccc; border-radius: 4px; }
        .error { color: red; font-size: 12px; margin-top: -10px; margin-bottom: 10px; }
        .modal-actions { text-align: right; }
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }

        @media (max-width: 768px) {
            table { display: block; overflow-x: auto; font-size: 12px; }
            .modal-content { width: 90%; }
        }
    </style>
</head>
    <body>
    <div id="root"></div>
    <script type="text/babel">
        function SearchBar({ value, onChange }) {
            return (
                <div className="search-bar">
                    <input
                        type="text"
                        placeholder="Tìm theo tên, email, địa chỉ..."
                        value={value}
                        onChange={(e) => onChange(e.target.value)}
                    />
                </div>
            );
        }

        function Pagination({ page, totalPages, limit, onPageChange, onLimitChange }) {
            return (
                <div className="pagination">
                    <div>
                        Hiển thị: 
                        <select value={limit} onChange={(e) => onLimitChange(Number(e.target.value))}>
                            <option value="3">3</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                        </select> dòng/trang
                    </div>
                    <div>
                        <button onClick={() => onPageChange(page - 1)} disabled={page <= 1}>Prev</button>
                        <span style={{ margin: '0 15px' }}>Trang {page}/{totalPages || 1}</span>
                        <button onClick={() => onPageChange(page + 1)} disabled={page >= totalPages}>Next</button>
                    </div>
                </div>
            );
        }

        function UserModal({ user, onClose, onSave }) {
            const [formData, setFormData] = React.useState(user || { name: "", age: "", email: "", address: "" });
            const [errors, setErrors] = React.useState({});

            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const validate = () => {
                const newErrors = {};
                if (!formData.name || formData.name.trim().length < 2) newErrors.name = "Tên phải có ít nhất 2 ký tự";
                if (!formData.age || formData.age < 0) newErrors.age = "Tuổi phải >= 0";
                if (!formData.email || !formData.email.includes("@") || !formData.email.includes(".")) newErrors.email = "Email không hợp lệ";
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = () => {
                if (!validate()) return;
                
                const cleanedData = {
                    name: formData.name.trim(),
                    age: Number(formData.age),
                    email: formData.email.trim(),
                    address: (formData.address || "").trim()
                };

                const url = user ? `http://localhost:3001/api/users/${user._id}` : 'http://localhost:3001/api/users';
                const method = user ? "PUT" : "POST";

                fetch(url, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(cleanedData) 
                })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        alert("Lỗi: " + data.error);
                    } else {
                        alert(data.message);
                        onSave();
                    }
                })
                .catch(err => alert("Lỗi: " + err.message));
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3>{user ? "Sửa người dùng" : "Thêm người dùng"}</h3>
                        <label>Họ tên *</label>
                        <input name="name" value={formData.name} onChange={handleChange} />
                        {errors.name && <p className="error">{errors.name}</p>}
                        
                        <label>Tuổi *</label>
                        <input name="age" type="number" value={formData.age} onChange={handleChange} />
                        {errors.age && <p className="error">{errors.age}</p>}
                        
                        <label>Email *</label>
                        <input name="email" type="email" value={formData.email} onChange={handleChange} />
                        {errors.email && <p className="error">{errors.email}</p>}
                        
                        <label>Địa chỉ</label>
                        <input name="address" value={formData.address} onChange={handleChange} />
                        
                        <div className="modal-actions">
                            <button onClick={handleSubmit} style={{background: '#4CAF50', color: 'white'}}>Lưu</button>
                            <button onClick={onClose} style={{background: '#f44336', color: 'white'}}>Hủy</button>
                        </div>
                    </div>
                </div>
            );
        }

        function UserTable({ users, onEdit, onDelete, page, limit }) {
            const handleDelete = (id, name) => {
                if (window.confirm(`Bạn có chắc muốn xóa người dùng "${name}" không?`)) {
                    onDelete(id);
                }
            };

            return (
                <table>
                    <thead>
                        <tr>
                            <th style={{ width: '5%' }}>STT</th>
                            <th style={{ width: '25%' }}>Họ tên</th>
                            <th style={{ width: '10%' }}>Tuổi</th>
                            <th style={{ width: '25%' }}>Email</th>
                            <th style={{ width: '20%' }}>Địa chỉ</th>
                            <th style={{ width: '15%' }}>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {users.length === 0 ? (
                            <tr><td colSpan="6" style={{ textAlign: 'center' }}>Không có dữ liệu</td></tr>
                        ) : (
                            users.map((user, index) => (
                                <tr key={user._id}>
                                    <td>{((page - 1) * limit) + index + 1}</td>
                                    <td>{user.name}</td>
                                    <td>{user.age}</td>
                                    <td>{user.email}</td>
                                    <td>{user.address || "-"}</td>
                                    <td>
                                        <button onClick={() => onEdit(user)} style={{background: '#FFC107'}}>Sửa</button>
                                        <button onClick={() => handleDelete(user._id, user.name)} style={{background: '#F44336', color: 'white'}}>Xóa</button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            );
        }
    
        function App() {
            // States
            const [users, setUsers] = React.useState([]);
            const [page, setPage] = React.useState(1);
            const [limit, setLimit] = React.useState(5);
            const [search, setSearch] = React.useState("");
            const [total, setTotal] = React.useState(0);
            const [totalPages, setTotalPages] = React.useState(0);
            const [showModal, setShowModal] = React.useState(false);
            const [editingUser, setEditingUser] = React.useState(null);
            // Fetch users
            const fetchUsers = () => {
            const url =
            `http://localhost:3001/api/users?page=${page}&limit=${limit}&search=${search}`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    setUsers(data.data);
                    setTotal(data.total);
                    setTotalPages(data.totalPages);
                })
                .catch(err => console.error("Fetch error:", err));
            };
            // useEffect: Gọi API khi page, limit, search thay đổi
            React.useEffect(() => {
                fetchUsers();
            }, [page, limit, search]);

            const deleteUser = (id) => {
                fetch(`http://localhost:3001/api/users/${id}`, {
                method: "DELETE"
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    fetchUsers(); // Phải gọi lại để cập nhật UI
                })
                .catch(err => alert("Lỗi: " + err.message));
                };
            return (
                <div className="container">
                <h1>Quản lý Người dùng</h1>
                <SearchBar value={search} onChange={setSearch} />
                <button style={{background: '#3f3fe7', color: 'white'}} onClick={() => { setEditingUser(null); setShowModal(true); }}>
                Thêm người dùng
                </button>
                <UserTable
                    users={users}
                    onEdit={(user) => { setEditingUser(user); setShowModal(true); }}
                    onDelete={(id) => deleteUser(id)}
                    page={page}
                    limit={limit}
                />
                <Pagination
                    page={page}
                    totalPages={totalPages}
                    limit={limit}
                    onPageChange={setPage}
                    onLimitChange={setLimit}
                />
                {showModal && (
                <UserModal
                    user={editingUser}
                    onClose={() => setShowModal(false)}
                    onSave={() => { fetchUsers(); setShowModal(false); }}
                />
                )}
            </div>
            );}

        // Render App
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>